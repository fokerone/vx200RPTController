const path = require('path');
require('dotenv').config();

// Configurar paths
process.env.NODE_PATH = path.join(__dirname, 'src');

const { ConfigManager } = require('./src/config/ConfigManager');
const AudioManager = require('./src/audio/audioManager');
const APRS = require('./src/modules/aprs');
const DirewolfManager = require('./src/utils/direwolfManager');

/**
 * Test b√°sico del sistema APRS
 */
async function testAPRSBasic() {
    console.log('üì° Test b√°sico del sistema APRS\n');

    let config, audio, aprs, direwolf;

    try {
        // Inicializar componentes
        console.log('üîß Inicializando componentes...');
        
        config = new ConfigManager();
        audio = new AudioManager(config);
        aprs = new APRS(audio);
        direwolf = new DirewolfManager();

        console.log('‚úÖ Componentes inicializados\n');

        // Test 1: Verificar configuraci√≥n APRS
        console.log('üìã === TEST 1: CONFIGURACI√ìN APRS ===');
        const aprsStatus = aprs.getStatus();
        console.log('Configuraci√≥n APRS:');
        console.log(`   Callsign: ${aprsStatus.config.callsign}`);
        console.log(`   Ubicaci√≥n: ${aprsStatus.config.location.lat}, ${aprsStatus.config.location.lon}`);
        console.log(`   Beacon: ${aprsStatus.config.beaconEnabled ? 'Habilitado' : 'Deshabilitado'}`);
        console.log();

        // Test 2: Verificar instalaci√≥n Direwolf
        console.log('üîç === TEST 2: DIREWOLF INSTALACI√ìN ===');
        const fs = require('fs');
        const direwolfInstalled = fs.existsSync('/usr/local/bin/direwolf');
        console.log(`Direwolf instalado: ${direwolfInstalled ? '‚úÖ S√ç' : '‚ùå NO'}`);
        
        if (direwolfInstalled) {
            console.log('Versi√≥n Direwolf:');
            try {
                const { spawn } = require('child_process');
                const version = spawn('direwolf', ['-t', '0'], { timeout: 3000 });
                version.stdout.on('data', (data) => {
                    const output = data.toString();
                    if (output.includes('Dire Wolf version')) {
                        console.log(`   ${output.split('\n')[0]}`);
                    }
                });
                setTimeout(() => version.kill('SIGKILL'), 2000);
            } catch (error) {
                console.log('   Error obteniendo versi√≥n');
            }
        }
        console.log();

        // Test 3: Probar generaci√≥n de configuraci√≥n Direwolf
        console.log('‚öôÔ∏è === TEST 3: CONFIGURACI√ìN DIREWOLF ===');
        const configGenerated = direwolf.generateConfig();
        console.log(`Configuraci√≥n generada: ${configGenerated ? '‚úÖ S√ç' : '‚ùå NO'}`);
        
        if (configGenerated) {
            const configPath = path.join(__dirname, 'config/direwolf.conf');
            const configExists = fs.existsSync(configPath);
            console.log(`Archivo config existe: ${configExists ? '‚úÖ S√ç' : '‚ùå NO'}`);
            
            if (configExists) {
                const configContent = fs.readFileSync(configPath, 'utf8');
                const hasCallsign = configContent.includes('MYCALL');
                const hasKissPort = configContent.includes('KISSPORT');
                const hasBeacon = configContent.includes('PBEACON');
                
                console.log(`   Callsign configurado: ${hasCallsign ? '‚úÖ' : '‚ùå'}`);
                console.log(`   Puerto KISS configurado: ${hasKissPort ? '‚úÖ' : '‚ùå'}`);
                console.log(`   Beacon configurado: ${hasBeacon ? '‚úÖ' : '‚ùå'}`);
            }
        }
        console.log();

        // Test 4: Verificar librer√≠a utils-for-aprs
        console.log('üì¶ === TEST 4: LIBRER√çA UTILS-FOR-APRS ===');
        try {
            const { SocketKISSFrameEndpoint, APRSInfoParser } = require('utils-for-aprs');
            console.log('‚úÖ utils-for-aprs instalado y accesible');
            console.log('   ‚úÖ SocketKISSFrameEndpoint disponible');
            console.log('   ‚úÖ APRSInfoParser disponible');
        } catch (error) {
            console.log('‚ùå Error cargando utils-for-aprs:', error.message);
        }
        console.log();

        // Test 5: Test de inicializaci√≥n APRS (sin conexi√≥n real)
        console.log('üöÄ === TEST 5: INICIALIZACI√ìN APRS ===');
        try {
            console.log('Inicializando m√≥dulo APRS (modo test)...');
            
            // Mock para evitar conexi√≥n real
            const originalInitialize = aprs.initializeKISSConnection;
            aprs.initializeKISSConnection = async () => {
                console.log('   Mock: Conexi√≥n KISS simulada');
                aprs.tncConnection = false; // Simular sin conexi√≥n
            };
            
            const initialized = await aprs.initialize();
            console.log(`Inicializaci√≥n APRS: ${initialized ? '‚úÖ √âXITO' : '‚ùå FALLO'}`);
            
            // Restaurar funci√≥n original
            aprs.initializeKISSConnection = originalInitialize;
            
        } catch (error) {
            console.log('‚ùå Error en inicializaci√≥n:', error.message);
        }
        console.log();

        // Test 6: Comandos APRS
        console.log('üìû === TEST 6: COMANDOS APRS ===');
        const commands = [
            { cmd: '*6', desc: 'Comando principal APRS' },
            { cmd: '*60', desc: 'Estado del sistema APRS' },
            { cmd: '*61', desc: 'Beacon manual' },
            { cmd: '*62', desc: '√öltimas posiciones' }
        ];

        for (const test of commands) {
            try {
                console.log(`Probando ${test.cmd} - ${test.desc}`);
                
                // Mock del audio para evitar TTS real
                const originalSpeak = audio.speak;
                let spokenMessage = '';
                audio.speak = async (message) => {
                    spokenMessage = message;
                    console.log(`   TTS Mock: "${message.substring(0, 50)}..."`);
                };
                
                await aprs.execute(test.cmd);
                console.log(`   ‚úÖ Comando ${test.cmd} ejecutado`);
                
                // Restaurar funci√≥n original
                audio.speak = originalSpeak;
                
            } catch (error) {
                console.log(`   ‚ùå Error en comando ${test.cmd}: ${error.message}`);
            }
        }
        console.log();

        // Test 7: Verificar estructura de datos
        console.log('üóÇÔ∏è === TEST 7: ESTRUCTURA DE DATOS ===');
        const finalStatus = aprs.getStatus();
        console.log('Estado final del m√≥dulo APRS:');
        console.log(`   Running: ${finalStatus.running}`);
        console.log(`   Initialized: ${finalStatus.initialized}`);
        console.log(`   TNC Connected: ${finalStatus.tncConnected}`);
        console.log(`   Positions total: ${finalStatus.positions.total}`);
        console.log(`   Beacons sent: ${finalStatus.stats.beaconsSent}`);
        console.log(`   Positions received: ${finalStatus.stats.positionsReceived}`);
        console.log();

        // Test 8: Verificar archivos de log
        console.log('üìÑ === TEST 8: ARCHIVOS DE LOG ===');
        const logDir = path.join(__dirname, 'logs');
        const logDirExists = fs.existsSync(logDir);
        console.log(`Directorio logs existe: ${logDirExists ? '‚úÖ S√ç' : '‚ùå NO'}`);
        
        if (logDirExists) {
            const positionsFile = path.join(logDir, 'aprs-positions.json');
            const positionsFileExists = fs.existsSync(positionsFile);
            console.log(`Archivo posiciones existe: ${positionsFileExists ? '‚úÖ S√ç' : '‚ùå NO'}`);
        }
        console.log();

        console.log('üéØ === DIAGN√ìSTICO FINAL ===');
        const allTestsPassed = direwolfInstalled && configGenerated;
        
        if (allTestsPassed) {
            console.log('‚úÖ SISTEMA APRS LISTO PARA PRODUCCI√ìN');
            console.log('   ‚úÖ Direwolf instalado y configurado');
            console.log('   ‚úÖ M√≥dulo APRS funcional');
            console.log('   ‚úÖ Librer√≠as necesarias disponibles');
            console.log('   ‚úÖ Comandos DTMF operativos');
            console.log();
            console.log('üìã PR√ìXIMOS PASOS:');
            console.log('   1. Configurar callsign real en Direwolf');
            console.log('   2. Ajustar coordenadas de ubicaci√≥n');
            console.log('   3. Conectar interface de radio');
            console.log('   4. Probar en vivo con estaciones APRS');
        } else {
            console.log('‚ö†Ô∏è SISTEMA APRS REQUIERE CONFIGURACI√ìN');
            if (!direwolfInstalled) {
                console.log('   ‚ùå Instalar Direwolf TNC');
            }
            if (!configGenerated) {
                console.log('   ‚ùå Generar configuraci√≥n Direwolf');
            }
        }

        return allTestsPassed;

    } catch (error) {
        console.error('\n‚ùå === ERROR EN TEST ===');
        console.error('Error:', error.message);
        console.error('Stack:', error.stack);
        
        return false;
    } finally {
        // Limpiar recursos
        console.log('\nüßπ Limpiando recursos...');
        
        try {
            if (aprs && typeof aprs.destroy === 'function') {
                aprs.destroy();
                console.log('‚úÖ APRS destruido');
            }
            
            if (direwolf && typeof direwolf.destroy === 'function') {
                direwolf.destroy();
                console.log('‚úÖ DirewolfManager destruido');
            }
            
            if (audio && typeof audio.destroy === 'function') {
                audio.destroy();
                console.log('‚úÖ AudioManager destruido');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Error limpiando:', error.message);
        }
        
        console.log('üèÅ Test finalizado\n');
    }
}

// Funci√≥n helper para delay
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Ejecutar test si se llama directamente
if (require.main === module) {
    testAPRSBasic()
        .then(success => {
            if (success) {
                console.log('üéØ RESULTADO: ¬°Sistema APRS configurado correctamente!');
                process.exit(0);
            } else {
                console.log('‚ùå RESULTADO: Sistema APRS requiere configuraci√≥n adicional');
                process.exit(1);
            }
        })
        .catch(error => {
            console.error('Error fatal:', error.message);
            process.exit(1);
        });
}

module.exports = testAPRSBasic;